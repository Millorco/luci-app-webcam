#!/bin/sh
# ---------------------------------------------------
#
# Capture image with EOS camera
#
# ---------------------------------------------------

. /usr/bin/webcam.cfg

cd /tmp
NOW_DATE="$(date +"%Y%m%d-%H%M")"
FILENAME="${WC_PHOTO_NAME}_${NOW_DATE}.jpg"
CIVIL_TWILIGHT_MINUTES=30  # Minuti prima/alba e dopo/tramonto


# ---------------------------------------------------
# Funzione per avviare la cattura in base a giorno/notte
# ---------------------------------------------------

start() {
	CURRENT_HOUR=$(date +%s 2>/dev/null)

	if [ -z "$CURRENT_HOUR" ]; then
		echo "$WC_NAME ERRORE: Impossibile ottenere l'ora UNIX corrente. Assicurati che 'date +%s' sia supportato."
		exit 1
	fi

	JSON_DATA=$(curl -s "https://api.sunrise-sunset.org/json?lat=$WC_LATITUDE&lng=$WC_LONGITUDE&formatted=0")

	SUNRISE_UTC=$(echo "$JSON_DATA" | grep '"sunrise"' | sed -n 's/.*"sunrise":"\([^"]*\)".*/\1/p')
	SUNSET_UTC=$(echo "$JSON_DATA" | grep '"sunset"' | sed -n 's/.*"sunset":"\([^"]*\)".*/\1/p')

	if [ -z "$SUNRISE_UTC" ] || [ -z "$SUNSET_UTC" ]; then
		echo "ERRORE: Estrazione dei valori dall'API fallita."
		echo "Risposta API: $JSON_DATA"
		exit 1
	fi

	SUNRISE_FMT=$(echo "$SUNRISE_UTC" | sed 's/T/ /' | sed 's/+00:00//')
	SUNSET_FMT=$(echo "$SUNSET_UTC" | sed 's/T/ /' | sed 's/+00:00//')

	SUNRISE_TS=$(date -d "$SUNRISE_FMT" +%s 2>/dev/null)
	SUNSET_TS=$(date -d "$SUNSET_FMT" +%s 2>/dev/null)

	if [ -z "$SUNRISE_TS" ] || [ -z "$SUNSET_TS" ]; then
		echo "ERRORE CRITICO: Il comando 'date -d' non Ã¨ riuscito a convertire gli orari UTC in secondi UNIX."
		echo "Questo accade spesso su sistemi minimali senza estensioni 'date' avanzate."
		exit 1
	fi

	if [ "$CURRENT_HOUR" -ge "$SUNRISE_TS" ] && [ "$CURRENT_HOUR" -lt "$SUNSET_TS" ]; then
		capture_day
	else
		capture_night
	fi
}


# ---------------------------------------------------
# Funzione cattura per giorno
# ---------------------------------------------------
capture_day() {
    rm -f ./*.jpg 2>/dev/null

    # Heizung aus, um genug Strom zu haben
    if [ "${WC_HEATING:-0}" -eq 1 ]; then
        . /usr/bin/serialsend h
    fi

    gphoto2 --set-config eosremoterelease=3 \
        --set-config eosremoterelease=4 \
        --set-config iso="$WC_ISO_DAY" \
        --set-config aperture="$WC_APERTURE_DAY" \
        --set-config shutterspeed="$WC_SHUTTERSPEED_DAY" \
        --get-all-metadata \
        --capture-image-and-download \
        --force-overwrite \
		--filename "$FILENAME" 2>&1 1>/dev/null

    # Heizung wieder auf vorherigen Stand
    if [ "${WC_HEATING:-0}" -eq 1 ]; then
        . /usr/bin/serialsend H
    fi

    upload
}


# ---------------------------------------------------
# Funzione cattura per notte
# ---------------------------------------------------
capture_night() {
    rm -f ./*.jpg 2>/dev/null

    # Heizung wieder auf vorherigen Stand
    if [ "${WC_HEATING:-0}" -eq 1 ]; then
        . /usr/bin/serialsend h
    fi

    gphoto2 --set-config eosremoterelease=3 \
        --set-config eosremoterelease=4 \
        --set-config iso="$WC_ISO_NIGHT" \
        --set-config aperture="$WC_APERTURE_NIGHT" \
        --set-config shutterspeed="$WC_SHUTTERSPEED_NIGHT" \
        --get-all-metadata \
        --capture-image-and-download \
        --force-overwrite \
		--filename "$FILENAME" 2>&1 1>/dev/null

    # Heizung wieder auf vorherigen Stand
    if [ "${WC_HEATING:-0}" -eq 1 ]; then
        . /usr/bin/serialsend H
    fi

    upload
}


# ---------------------------------------------------
# Upload to FTP server
# ---------------------------------------------------
upload() {
    # Verifica che il file da caricare esista
    if [ ! -f "$FILENAME" ]; then
        echo "Errore: Il file '$FILENAME' non esiste"
        exit 1
    fi

    # Crea struttura cartelle basata sulla data corrente
    YEAR=$(date +"%Y")
    MONTH=$(date +"%m")
    DAY=$(date +"%d")

    # Costruisce il percorso remoto
    REMOTE_PATH="$WC_UPLOAD_DIRECTORY/$YEAR/$MONTH/$DAY"

    # Esegue l'upload creando automaticamente le directory
    curl -s -S -T "$FILENAME" \
        --user "$WC_UPLOAD_USERNAME:$WC_UPLOAD_PASSWORD" \
        --ftp-create-dirs \
        "ftp://$WC_UPLOAD_SERVER/$REMOTE_PATH/$FILENAME"

    # Controlla il risultato dell'operazione
    if [ $? -eq 0 ]; then
        echo "$WC_NAME Upload completato con successo!"
        exit 0
    else
        echo "$WC_NAME Errore durante l'upload del file"
        exit 1
    fi
}




start
